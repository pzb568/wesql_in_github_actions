name: 启动临时 WeSQL 数据库（ngrok 版）

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: 检查 Secrets
        env:
          WESQL_ROOT_PASSWORD: ${{ secrets.WESQL_ROOT_PASSWORD }}
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if [ -z "${WESQL_ROOT_PASSWORD}" ] || [ -z "${NGROK_AUTH_TOKEN}" ]; then
            echo "::error::必须提供 WESQL_ROOT_PASSWORD 和 NGROK_AUTH_TOKEN"
            exit 1
          fi

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl docker.io
          sudo systemctl start docker

      - name: 启动 WeSQL
        run: |
          docker run -d \
            --name wesql-server \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD="${{ secrets.WESQL_ROOT_PASSWORD }}" \
            apecloud/wesql-server:8.0.35

          sleep 20
          docker logs wesql-server --tail 50

      - name: 下载并启动 ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install -y ngrok

          ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
          nohup ngrok tcp 3306 > ngrok.log 2>&1 &
          sleep 10

          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*')
          HOST=$(echo "$NGROK_URL" | cut -d':' -f2 | sed 's|//||')
          PORT=$(echo "$NGROK_URL" | cut -d':' -f3)

          echo "HOST=${HOST}" >> $GITHUB_ENV
          echo "PORT=${PORT}" >> $GITHUB_ENV

      - name: 输出连接信息
        run: |
          echo "======================"
          echo "WeSQL 数据库连接信息"
          echo "======================"
          echo "主机: ${{ env.HOST }}"
          echo "端口: ${{ env.PORT }}"
          echo "用户名: root"
          echo "密码: [保密]"
          echo "有效期: 临时（约2小时）"
          echo "======================"

      - name: 保持运行
        timeout-minutes: 120
        run: |
          echo "容器运行中，ngrok 隧道有效期约 2 小时"
          while docker ps | grep -q wesql-server; do
            sleep 60
          done
