name: Start WeSQL with Cloudflare Tunnel

on:
  workflow_dispatch:

concurrency:
  group: start_wesql_database
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: å®‰è£…ä¾èµ–ä¸ cloudflared
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd python3-pip docker.io
          pip3 install awscli
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared && sudo mv cloudflared /usr/local/bin/

      - name: å¯åŠ¨ WeSQL å®¹å™¨
        run: |
          docker run -d --name wesql-server \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD="${{ secrets.WESQL_ROOT_PASSWORD }}" \
            apecloud/wesql-server:8.0.35-0.1.0_beta3.38

      - name: ç­‰å¾… WeSQL å¯åŠ¨
        run: |
          for i in {1..30}; do
            if nc -z localhost 3306; then
              echo "âœ… WeSQL å¯åŠ¨æˆåŠŸ"
              exit 0
            fi
            echo "âŒ› ç­‰å¾…æ•°æ®åº“å¯åŠ¨ä¸­... ($i/30)"
            sleep 5
          done
          echo "::error::âŒ WeSQL å¯åŠ¨å¤±è´¥"
          docker logs wesql-server
          exit 1

      - name: å¯åŠ¨ Cloudflare Tunnel
        id: tunnel
        run: |
          cloudflared tunnel --url tcp://localhost:3306 --no-autoupdate --logfile tunnel.log &
          sleep 10
          TUNNEL_URL=$(grep -oE 'tcp://[a-z0-9.-]+:[0-9]+' tunnel.log | head -n1)
          if [ -z "$TUNNEL_URL" ]; then
            echo "::error::âŒ Cloudflare Tunnel å¯åŠ¨å¤±è´¥"
            cat tunnel.log
            exit 1
          fi
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          echo "ğŸŒ Cloudflare Tunnel åœ°å€: $TUNNEL_URL"

      - name: ç”Ÿæˆå¹¶ä¸Šä¼ è¿æ¥ä¿¡æ¯é¡µé¢
        run: |
          HOST=$(echo "${{ env.TUNNEL_URL }}" | cut -d':' -f2 | tr -d '/')
          PORT=$(echo "${{ env.TUNNEL_URL }}" | cut -d':' -f3)

          cat > connection_info.html <<EOF
          <html>
          <body>
          <h2>WeSQL æ•°æ®åº“è¿œç¨‹è¿æ¥ä¿¡æ¯</h2>
          <ul>
            <li><b>ä¸»æœºåœ°å€:</b> <code>$HOST</code></li>
            <li><b>ç«¯å£:</b> <code>$PORT</code></li>
            <li><b>ç”¨æˆ·å:</b> root</li>
            <li><b>å¯†ç :</b> ${{ secrets.WESQL_ROOT_PASSWORD }}</li>
            <li><b>CLI ç¤ºä¾‹:</b><br>
              <code>mysql -h $HOST -P $PORT -u root -p</code>
            </li>
          </ul>
          <p>âš ï¸ æ­¤è¿æ¥æœ‰æ•ˆæœŸä¸º 6 å°æ—¶ã€‚</p>
          </body>
          </html>
          EOF

          aws configure set aws_access_key_id "${{ secrets.WESQL_OBJECTSTORE_ACCESS_KEY }}"
          aws configure set aws_secret_access_key "${{ secrets.WESQL_OBJECTSTORE_SECRET_KEY }}"
          aws configure set default.region us-east-1
          aws configure set default.s3.signature_version s3v4
          aws configure set default.s3.endpoint_url "${{ secrets.WESQL_OBJECTSTORE_ENDPOINT_URL }}"

          TIMESTAMP=$(date +%s)
          aws s3 cp connection_info.html s3://${{ secrets.WESQL_OBJECTSTORE_BUCKET }}/wesql_connection_$TIMESTAMP.html || {
            echo "::error::ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¡®è®¤ R2 Bucket åç§°ä¸ endpoint æ˜¯å¦æ­£ç¡®"
            exit 1
          }

      - name: ä¿æŒè¿è¡Œï¼ˆ6å°æ—¶ï¼‰
        run: |
          echo "æœåŠ¡è¿è¡Œä¸­ï¼Œ6å°æ—¶åè‡ªåŠ¨æ¸…ç†..."
          for i in {1..360}; do
            if ! docker ps | grep -q wesql-server; then
              echo "::error::æ•°æ®åº“å®¹å™¨ä¸­æ–­ï¼Œç»ˆæ­¢å®ˆæŠ¤"
              exit 1
            fi
            sleep 60
          done

      - name: æ¸…ç†èµ„æº
        if: always()
        run: |
          docker stop wesql-server || true
          docker rm wesql-server || true
          pkill -f cloudflared || true
