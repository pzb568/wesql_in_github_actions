name: 构建并启动 WeSQL 数据库

on:
  workflow_dispatch:

concurrency:
  group: build_and_start_wesql
  cancel-in-progress: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60 # 整个作业的超时时间，足够完成构建和启动

    steps:
      - name: 检查必要 Secrets
        env:
          SECRET_WESQL_ROOT_PASSWORD: ${{ secrets.WESQL_ROOT_PASSWORD }}
          SECRET_R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          SECRET_R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          SECRET_R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          SECRET_R2_ENDPOINT_URL: ${{ secrets.R2_ENDPOINT_URL }}
        run: |
          echo "检查必要Secrets..."
          secrets=(
            "SECRET_WESQL_ROOT_PASSWORD"
            "SECRET_R2_ACCESS_KEY_ID"
            "SECRET_R2_SECRET_ACCESS_KEY"
            "SECRET_R2_BUCKET_NAME"
            "SECRET_R2_ENDPOINT_URL"
          )
          missing=0
          for s in "${secrets[@]}"; do
            if [ -z "${!s}" ]; then
              echo "::error::缺少Secret: ${s#SECRET_}"
              missing=$((missing+1))
            fi
          done
          if [ $missing -gt 0 ]; then
            echo "::error::缺少 $missing 个必要Secrets"
            exit 1
          fi

      - name: 安装依赖工具
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io git build-essential cmake python3-pip
          pip3 install awscli

      - name: 克隆 WeSQL 源码
        run: |
          git clone https://github.com/apecloud/wesql-server.git
          cd wesql-server
          git checkout master

      - name: 构建 WeSQL 镜像
        working-directory: wesql-server
        run: |
          docker build -t custom-wesql-server .

      - name: 清理旧容器
        run: |
          # 停止并移除可能存在的同名容器和卷
          docker stop wesql-server || true
          docker rm -f wesql-server || true
          docker volume rm wesql-data || true

      - name: 准备 MySQL 配置
        run: |
          # 创建自定义的 MySQL 配置文件
          cat > mysql_custom.cnf <<EOF
          [mysqld]
          port=3306
          log-bin=binlog
          gtid_mode=ON
          enforce_gtid_consistency=ON
          log_slave_updates=ON
          binlog_format=ROW
          EOF

      - name: 启动 WeSQL 容器
        run: |
          # 查找一个可用的管理端口
          MANAGEMENT_PORT=$(comm -23 <(seq 20000 30000 | sort) <(ss -tan | awk '{print $4}' | cut -d':' -f2 | sort -u) | shuf | head -n1)
          echo "MANAGEMENT_PORT=${MANAGEMENT_PORT}" >> $GITHUB_ENV # 将端口保存为环境变量供后续步骤使用

          # 启动 WeSQL Docker 容器
          docker run -d \
            --name wesql-server \
            --restart unless-stopped \
            -p 3306:3306 \
            -p ${MANAGEMENT_PORT}:13306 \
            -v wesql-data:/data/mysql \
            -v "$(pwd)/mysql_custom.cnf:/etc/mysql/conf.d/custom.cnf" \
            -e WESQL_CLUSTER_MEMBER="127.0.0.1:${MANAGEMENT_PORT}" \
            -e MYSQL_ROOT_PASSWORD="${{ secrets.WESQL_ROOT_PASSWORD }}" \
            -e WESQL_OBJECTSTORE_ACCESS_KEY="${{ secrets.R2_ACCESS_KEY_ID }}" \
            -e WESQL_OBJECTSTORE_SECRET_KEY="${{ secrets.R2_SECRET_ACCESS_KEY }}" \
            -e WESQL_OBJECTSTORE_ENDPOINT_URL="${{ secrets.R2_ENDPOINT_URL }}" \
            -e WESQL_OBJECTSTORE_PROVIDER="s3" \
            -e WESQL_OBJECTSTORE_BUCKET="${{ secrets.R2_BUCKET_NAME }}" \
            -e WESQL_OBJECTSTORE_REGION="auto" \
            -e WESQL_OBJECTSTORE_REPO_ID="tutorial" \
            -e WESQL_OBJECTSTORE_BRANCH_ID="main" \
            custom-wesql-server

          echo "等待容器初始化..."
          sleep 20 # 给予容器一些时间进行初步启动
          docker logs wesql-server --tail 50 # 显示最新的容器日志

      - name: 等待 MySQL 启动
        timeout-minutes: 5 # 最多等待 5 分钟
        run: |
          for i in {1..30}; do # 尝试 30 次，每次间隔 5 秒
            if docker exec -e MYSQL_PWD="${{ secrets.WESQL_ROOT_PASSWORD }}" wesql-server \
              mysqladmin ping -u root --silent; then
              echo "MySQL 已成功启动"
              exit 0 # MySQL 启动成功，退出循环
            fi
            echo "等待MySQL启动(${i}/30)..."
            sleep 5
          done
          echo "::error::MySQL 启动超时" # 如果循环结束 MySQL 仍未启动，则报错
          docker logs wesql-server # 打印容器日志以帮助调试
          exit 1

      - name: 生成连接信息
        run: |
          # 创建包含连接信息的文件
          cat > connection_info.txt <<EOF
          ========================
          WeSQL 数据库连接信息
          ========================
          主机: localhost
          端口: 3306
          用户名: root
          密码: [保密]
          管理端口: ${{ env.MANAGEMENT_PORT }}
          ------------------------
          注意: 此数据库实例仅在GitHub Actions作业运行期间存在，作业完成后将销毁。
          ========================
          EOF
          cat connection_info.txt # 在日志中显示连接信息

      - name: 上传连接信息到R2
        run: |
          # 将连接信息文件上传到 R2 存储桶
          aws s3 cp connection_info.txt "s3://${{ secrets.R2_BUCKET_NAME }}/wesql_connection_$(date +%s).txt"

      # 移除了 '保持服务运行' 步骤。
      # GitHub Actions 不适合作为长期运行服务的托管平台。
      # 一旦数据库成功启动并其状态得到验证，此作业即完成。
      # 如果需要持久化的数据库实例，请考虑将其部署到专用服务器或云服务。

      - name: 清理资源
        if: always() # 确保此步骤总是在作业结束时运行，无论之前的步骤是否成功
        run: |
          echo "清理 Docker 资源..."
          docker stop wesql-server || true # 停止容器，如果不存在则忽略错误
          docker rm -f wesql-server || true # 强制删除容器
          docker volume rm wesql-data || true # 删除数据卷
          echo "资源清理完毕。"

