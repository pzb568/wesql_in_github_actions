name: Start WeSQL with Cloudflare Tunnel

on:
  workflow_dispatch:
    inputs:
      keepalive_minutes:
        description: "ä¿æŒè¿è¡Œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰"
        required: true
        default: "30"

concurrency:
  group: start_wesql_database
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: å®‰è£…ä¾èµ–ä¸ cloudflared
        run: |
          sudo apt-get update
          sudo apt-get install -y curl netcat-openbsd python3-pip
          pip3 install awscli
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared && sudo mv cloudflared /usr/local/bin/

      - name: å¯åŠ¨ WeSQL å®¹å™¨
        run: |
          docker run -d --name wesql-server \
            -p 3306:3306 \
            -e MYSQL_ROOT_PASSWORD="${{ secrets.WESQL_ROOT_PASSWORD }}" \
            apecloud/wesql-server:8.0.35-0.1.0_beta3.38

      - name: ç­‰å¾… WeSQL å¯åŠ¨
        run: |
          for i in {1..30}; do
            if nc -z localhost 3306; then
              echo "WeSQL å¯åŠ¨æˆåŠŸ"
              exit 0
            fi
            echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨ä¸­..."
            sleep 5
          done
          echo "::error::WeSQL å¯åŠ¨å¤±è´¥"
          docker logs wesql-server
          exit 1

      - name: å¯åŠ¨ Cloudflare Tunnel
        id: tunnel
        run: |
          cloudflared tunnel --url tcp://localhost:3306 --no-autoupdate --logfile tunnel.log &
          
          echo "ç­‰å¾… Cloudflare Tunnel å¯åŠ¨..."
          for i in {1..20}; do
            URL=$(grep -oE 'tcp://[a-z0-9.-]+:[0-9]+' tunnel.log | head -n1)
            if [ -n "$URL" ]; then
              break
            fi
            sleep 1
          done

          if [ -z "$URL" ]; then
            echo "::error::Cloudflare Tunnel å¯åŠ¨å¤±è´¥æˆ–è¶…æ—¶"
            cat tunnel.log
            exit 1
          fi
          
          echo "TUNNEL_URL=$URL" >> $GITHUB_ENV
          echo "Cloudflare Tunnel åœ°å€ï¼š$URL"

      - name: ç”Ÿæˆå¹¶ä¸Šä¼ è¿œç¨‹è¿æ¥ä¿¡æ¯è‡³ Cloudflare R2
        id: upload
        run: |
          HOST=$(echo "${{ env.TUNNEL_URL }}" | cut -d':' -f2 | tr -d '/')
          PORT=$(echo "${{ env.TUNNEL_URL }}" | cut -d':' -f3)
          NOW=$(date -u '+%Y-%m-%d %H:%M:%S')
          EXPIRE=$(date -u -d "+${{ github.event.inputs.keepalive_minutes }} minutes" '+%Y-%m-%d %H:%M:%S')

          echo "HOST=$HOST" >> $GITHUB_ENV
          echo "PORT=$PORT" >> $GITHUB_ENV

          cat > connection_info.html <<EOF
          <html>
          <body>
          <h2>WeSQL æ•°æ®åº“è¿œç¨‹è¿æ¥ä¿¡æ¯</h2>
          <ul>
            <li><b>ä¸»æœºåœ°å€:</b> <code>$HOST</code></li>
            <li><b>ç«¯å£:</b> <code>$PORT</code></li>
            <li><b>ç”¨æˆ·å:</b> root</li>
            <li><b>å¯†ç :</b> è¯·ä½¿ç”¨ GitHub Secret ä¸­è®¾ç½®çš„å¯†ç </li>
            <li><b>CLI ç¤ºä¾‹:</b><br>
              <code id="cli">mysql -h $HOST -P $PORT -u root -p</code>
              <button onclick="navigator.clipboard.writeText(document.getElementById('cli').innerText)">å¤åˆ¶</button>
            </li>
            <li><b>MySQL URI:</b><br>
              <code>mysql://root:[YOUR_PASSWORD]@$HOST:$PORT</code>
            </li>
            <li><b>å›¾å½¢ç•Œé¢å·¥å…·è¿æ¥:</b> å¯ä½¿ç”¨ 
              <a href="https://dbeaver.io">DBeaver</a>ã€
              <a href="https://www.mysql.com/products/workbench/">MySQL Workbench</a> æˆ– Navicatã€‚
            </li>
          </ul>
          <p>ğŸ”’ è¿æ¥åˆ›å»ºäºï¼š<code>$NOW UTC</code></p>
          <p>â³ æœ‰æ•ˆæœŸè‡³ï¼š<code>$EXPIRE UTC</code></p>
          </body>
          </html>
          EOF

          aws configure set aws_access_key_id "${{ secrets.WESQL_OBJECTSTORE_ACCESS_KEY }}"
          aws configure set aws_secret_access_key "${{ secrets.WESQL_OBJECTSTORE_SECRET_KEY }}"
          aws configure set default.region us-east-1

          TIMESTAMP=$(date +%s)
          FILENAME="wesql_connection_$TIMESTAMP.html"
          aws s3 cp connection_info.html s3://${{ secrets.WESQL_OBJECTSTORE_BUCKET }}/$FILENAME \
            --endpoint-url "${{ secrets.WESQL_OBJECTSTORE_ENDPOINT_URL }}"

          echo "S3_LINK=${{ secrets.WESQL_OBJECTSTORE_ENDPOINT_URL }}/${{ secrets.WESQL_OBJECTSTORE_BUCKET }}/$FILENAME" >> $GITHUB_ENV

      - name: è¾“å‡ºè¿œç¨‹è¿æ¥é¡µé¢é“¾æ¥
        run: |
          echo "âœ… è¿œç¨‹è¿æ¥ä¿¡æ¯é¡µé¢ï¼š"
          echo "${{ env.S3_LINK }}"

      - name: è¾“å‡ºå¿«é€Ÿè¿æ¥å‘½ä»¤
        run: |
          echo "âœ… å¿«é€Ÿè¿æ¥å‘½ä»¤ (å¤åˆ¶å¹¶ç²˜è´´åˆ°ç»ˆç«¯):"
          echo "mysql -h ${{ env.HOST }} -P ${{ env.PORT }} -u root -p"

      - name: ä¿æŒè¿è¡ŒæŒ‡å®šæ—¶é—´
        run: |
          echo "æœåŠ¡å·²å¯åŠ¨ï¼Œä¿æŒè¿è¡Œ ${{ github.event.inputs.keepalive_minutes }} åˆ†é’Ÿ..."
          sleep $((${{ github.event.inputs.keepalive_minutes }} * 60))

      - name: æ¸…ç†èµ„æº
        if: always()
        run: |
          docker stop wesql-server || true
          docker rm wesql-server || true
          pkill -f cloudflared || true
